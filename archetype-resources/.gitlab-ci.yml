image: docker:latest

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=/cache/.m2/repository"
  REGISTRY: "registry.cn-hangzhou.aliyuncs.com"

stages:
  - package
  - build

maven-package:
  image: maven:3.6-jdk-8-slim
  stage: package
  script:
    - mvn $$MAVEN_OPTS clean package -Dmaven.test.skip=true
    - cp target/${artifact_id}.jar /cache/jars/
  only:
    - tags

docker-build:
  stage: build
  image: docker:latest
  script:
    - echo "Building Dockerfile-based application..."
    - docker info
    - docker login --username=admin@yuanfen.net registry.cn-hangzhou.aliyuncs.com -p 4J0RPue8Zgifql9J
    - mkdir target
    - cp /cache/jars/${artifact_id}.jar target
    - docker build -t $$REGISTRY/yuanfen/${artifact_id}:$$CI_COMMIT_REF_NAME -t $$REGISTRY/yuanfen/${artifact_id}:latest .
    - docker push $$REGISTRY/yuanfen/${artifact_id}:$$CI_COMMIT_REF_NAME
    - docker push $$REGISTRY/yuanfen/${artifact_id}:latest
  only:
    - tags